# transaction.atomicについて

DBのことをよく知らない人でもわかるような説明を目指して書いてみる。  
これはDB操作の際に使われる魔法の呪文の説明。

### ■そもそもtransaction(トランザクション)とは

google先生に聞いてみた
```
Oxford Languagesの定義 · 詳細
トランザクション
1.取引。「銀行間の―」
2.コンピュータ システムにおける、永続的なデータに対する不可分な一連の処理。
```
Djangoでは2番目の意味になる。  
具体的にはスマホげーのガチャを思い浮かべましょう。ガチャを回すのに最低限必要なDB処理はきっと次の通り、
* 魔法石をプレーヤーの残高から減らす。
* 排出されたアイテムを、プレーヤーの持ち物に追加する。 

これらはどちらか一方が欠けたらゲームが崩壊することになる。
ガチャを回すときは必ずセットで実行されるべき処理。  
この、**まとめて行うべき処理のセット、のことをトランザクション**と呼ぶ。

### ■そもそもatomicとは
IT業界ではよくAtomicityと呼ばれると思う。  
atomicityをgoogle先生に聞いてみた  
https://e-words.jp/w/%E5%8E%9F%E5%AD%90%E6%80%A7.html
```
原子性 【atomicity】 不可分性 / アトミック性
原子性とは、ある物事が、それ以上細かい単位や要素に分割されない、またはできない性質のこと。

データベースシステムのトランザクション処理などで、一連のものとして定義された処理がすべて完了するか、一つも実行されないかのいずれか状態になることを原子性という。
```
トランザクションが分かれば、atomicは最後の一文でわかるな…？  
ガチャの例でいうと、DB処理は次のどちらかになるべき、ということ  
* プレーヤーの魔法石は減り、持ち物にはアイテムが追加される
* プレーヤーの魔法石は減らないし、持ち物にアイテムが追加されることもない  

**DB処理の一部だけ実行して終わる、というような半端な状態は許さないのがatomic**  
余談だが、IT用語としてACID特性というものがある。この中のAにあたるのがAtomicity(原子性)。  
興味があれば、他のCIDについても調べておくとよい。

### ■transaction.atomicとは
もう理解できるはず。transaction.atomicとは、
```
これからまとまった処理するぜ。  
結果はすべてのDB保存更新処理が成功するか、何のDB変更も起きないの二択だ。  
行くぜオラァァ（以下トランザクション処理）
```
という宣言になる。


### ■実際にtransaction.atomicは何をしているか  

何をしているかを説明する前に、Djangoの仕組みについて、  
Djangoでは（というか、たいていのシステムのデフォルトでは）、autocommitという仕組みを採用している。

#### ・autocommitについて
commitをgoogle先生にきいてみた
```
コミット 【commit】 コミットメント / commitment
ITの分野では、処理や変更などを確定させる、反映させる、といった意味で用いられることが多い。
```
書いてあることそのまま、DB周りで commit するということは、  
**DBに実際に書き込み変更を確定させる**、という意味になる。  
それが auto ということはどういうことかというと、  
DB変更命令が勝手に実行・書き込みされるということ。  
事務申請が偉い人の承認をスキップして受理される感覚に似ている。

ガチャで例えると、魔法石を減らせとDBに命じた瞬間に、所持魔法石の数値が実際に書き変わる。  
プレーヤーの持ち物にアイテムを追加する処理が正しく終えれるかの判定を待たずに…(致命的)

**これではAtomicityなど実現できない。**

#### ・俺はautocommitを辞めるぞ!!JOJO---!!
transaction.atomicは考えた
```
Atomicityを実現するために、autocommitは辞めざるを得ない。  
DBへの命令は先にキャンセルしやすい仮commitとしてメモをとり、最後に本commitで変更を一斉確定する仕組みに変えよう。  
途中でヤバい不具合を発見した時は、仮commitをキャンセルして何もなかったことにしたらいい。  
合図はどうする？何も言われなければ順調と思おう。ヤバい時は、例外(Exception)を投げてもらう。
```

#### ・実際のコードで起きていること
autocommitの場合
```python
Mahouseki.update("魔法石を減らす処理")  # DB本体へ実際にcommit!!もう後戻りできない。
# ここで魔法石だけ減ってる状態になる。後には戻れない。
Item.insert("ガチャアイテムを追加する")  # DB本体へ実際にcommit!!
# Mahouseki.update()が成功し、Item.insert()の実行が失敗した場合魔法石が減るだけの悲しい結果になる
```

transaction.atomicの場合
```python
with transaction.atomic     # ここから仮commitメモを取り始めるぜ
	Mahouseki.update("魔法石を減らす処理")  # 仮commitメモをとる
	if Yabai: # もしヤバいときは
		raise Exception # 例外を投げて通知
	# ここでは一応魔法石が減ってアイテムが増えていない状態ではあるが、
	# 本commitさえしなければ、作業完了後にはなかったことになる。

	Item.insert("ガチャアイテムを追加する")  # 更に仮commitメモをとる
	if Yabai: # もしヤバいときは
		raise Exception # 例外を投げて通知
	# 本commitさえしなければ、作業完了後になかったことになる。


# ここまで処理がきたらDB本体へ本commit!!後には戻れない。
# Exceptionが通知されていたらメモを変更前の状態に修正。変更はなかったことに。
```

#### ・transaction.atomicのアンチパターン
トランザクションの中でtry-except(catch)すると事故のもと
```python
with transaction.atomic     # ここから仮commitメモを取り始めるぜ
	Mahouseki.update("魔法石を減らす処理")  # 仮commitメモをとる
	Item.insert("ガチャアイテムを追加する")  # 更に仮commitメモをとる
	try: # 例外監視の基本機能
		if Yabai: # もしヤバいときは
			raise Exception # 例外を投げて通知
	except: # 監視機能が見つけた例外はexceptが責任もって処理する。
		log.error("ヤバい")

# exceptのおかげで例外なんてなかったってことでいいね。例外ないからcommitするわ。
```

